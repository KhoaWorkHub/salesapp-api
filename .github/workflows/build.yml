name: Build and Test Spring Boot App

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›  Checkout source code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: '17'

      - name: ğŸ—ï¸ Grant execute permission to Gradle wrapper
        run: chmod +x gradlew

      - name: ğŸ³ Start SQL Server container
        run: |
          docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=123" -e "MSSQL_PID=Developer" \
                    -p 1433:1433 --name sql-server -d \
                    mcr.microsoft.com/mssql/server:2019-latest
          
          # Wait for SQL Server to start
          sleep 20s
          
          # Create the database
          docker exec sql-server /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 123 \
                 -Q "CREATE DATABASE [SalesAppDB-Dev]"

      - name: ğŸ“¦ Build with Gradle
        run: ./gradlew build

      - name: ğŸ§ª Run tests
        run: ./gradlew test